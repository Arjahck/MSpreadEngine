"""
Base malware class and malware-specific implementations.

This module defines the core malware behavior and specific malware types
(worm, virus, ransomware).
"""

from abc import ABC, abstractmethod
from typing import List, Dict, Optional
from enum import Enum


class MalwareType(Enum):
    """Enumeration of malware types."""
    WORM = "worm"
    VIRUS = "virus"
    RANSOMWARE = "ransomware"
    TROJAN = "trojan"


class Malware(ABC):
    """Abstract base class for malware types."""

    def __init__(
        self,
        malware_id: str,
        malware_type: MalwareType,
        infection_rate: float = 0.3,
        latency: int = 1,
        **attributes
    ):
        """
        Initialize malware.

        Args:
            malware_id: Unique identifier for the malware instance
            malware_type: Type of malware
            infection_rate: Probability of infection per connection (0-1)
            latency: Time steps before infection spreads
            **attributes: Additional malware-specific attributes
        """
        self.malware_id = malware_id
        self.malware_type = malware_type
        self.infection_rate = infection_rate
        self.latency = latency
        self.infected_devices = set()
        self.attributes = attributes

    @abstractmethod
    def spread(self, infected_device: str, neighbors: List[str]) -> List[str]:
        """
        Determine which neighbors get infected.

        Args:
            infected_device: ID of the infected device
            neighbors: List of neighboring device IDs

        Returns:
            List of newly infected device IDs
        """
        pass

    @abstractmethod
    def get_behavior(self) -> Dict:
        """
        Get malware behavior characteristics.

        Returns:
            Dictionary describing malware behavior
        """
        pass

    def mark_infected(self, device_id: str) -> None:
        """
        Mark a device as infected.

        Args:
            device_id: Device ID
        """
        self.infected_devices.add(device_id)

    def get_infected_count(self) -> int:
        """
        Get the number of infected devices.

        Returns:
            Count of infected devices
        """
        return len(self.infected_devices)


class Worm(Malware):
    """Worm malware implementation."""

    def __init__(self, malware_id: str, **kwargs):
        """Initialize a worm."""
        super().__init__(malware_id, MalwareType.WORM, **kwargs)

    def spread(self, infected_device: str, neighbors: List[str]) -> List[str]:
        """
        Worms spread aggressively to all connected devices.

        Args:
            infected_device: ID of the infected device
            neighbors: List of neighboring device IDs

        Returns:
            List of newly infected device IDs
        """
        import random
        newly_infected = []
        for neighbor in neighbors:
            if neighbor not in self.infected_devices:
                if random.random() < self.infection_rate:
                    newly_infected.append(neighbor)
        return newly_infected

    def get_behavior(self) -> Dict:
        """Get worm behavior characteristics."""
        return {
            "type": "worm",
            "spread_rate": "high",
            "self_replicating": True,
            "network_aware": True,
        }


class Virus(Malware):
    """Virus malware implementation."""

    def __init__(self, malware_id: str, **kwargs):
        """Initialize a virus."""
        super().__init__(malware_id, MalwareType.VIRUS, **kwargs)

    def spread(self, infected_device: str, neighbors: List[str]) -> List[str]:
        """
        Viruses spread more selectively than worms.

        Args:
            infected_device: ID of the infected device
            neighbors: List of neighboring device IDs

        Returns:
            List of newly infected device IDs
        """
        import random
        newly_infected = []
        # Viruses require user interaction, so lower infection rate
        adjusted_rate = self.infection_rate * 0.6
        for neighbor in neighbors:
            if neighbor not in self.infected_devices:
                if random.random() < adjusted_rate:
                    newly_infected.append(neighbor)
        return newly_infected

    def get_behavior(self) -> Dict:
        """Get virus behavior characteristics."""
        return {
            "type": "virus",
            "spread_rate": "medium",
            "self_replicating": True,
            "requires_user_interaction": True,
        }


class Ransomware(Malware):
    """Ransomware malware implementation."""

    def __init__(self, malware_id: str, **kwargs):
        """Initialize ransomware."""
        super().__init__(malware_id, MalwareType.RANSOMWARE, **kwargs)

    def spread(self, infected_device: str, neighbors: List[str]) -> List[str]:
        """
        Ransomware spreads carefully to maximize impact.

        Args:
            infected_device: ID of the infected device
            neighbors: List of neighboring device IDs

        Returns:
            List of newly infected device IDs
        """
        import random
        newly_infected = []
        # Ransomware is more selective but potentially more damaging
        adjusted_rate = self.infection_rate * 0.8
        for neighbor in neighbors:
            if neighbor not in self.infected_devices:
                if random.random() < adjusted_rate:
                    newly_infected.append(neighbor)
        return newly_infected

    def get_behavior(self) -> Dict:
        """Get ransomware behavior characteristics."""
        return {
            "type": "ransomware",
            "spread_rate": "medium-high",
            "encrypts_files": True,
            "demands_ransom": True,
        }
